# 非同期バッチと過渡期のデータについて
非同期バッチの全体例ここに記載する。

## システムの全体像
「メインシステム」(以降メインと呼称) と「サブシステム」(以降サブと呼称) が存在しており、メインからサブへ連携ファイル(CSV)を送ることで、サブへ指示をしている。

### 処理の流れ
1. メインから連携ファイルが作成される。
2. ジョブでファイル監視が常駐しており、(1)でputされたファイルを検知する。
3. 非同期バッチの連携受付処理がジョブから呼び出され、キューテーブルに登録される。
4. (3)に次いで、ワークテーブルに連携データを一時的に登録する。
5. 別に常駐している非同期バッチメイン処理が、一定間隔でキューテーブルを確認し、キューに応じた機能を呼び出す。
6. 非同期バッチメイン処理がサブの各テーブルへ連携データを登録する。

メインシステムが連携ファイルをput --> ファイル監視 --> 非同期バッチ連携受付 --> キューテーブル --> 常駐している非同期バッチ --> 非同期バッチメイン処理 --> サブシステムへ連携データの登録

## 過渡期のデータ
改修にあたり、過渡期のデータでエラーを出さないようにする実装方法を記載する。

### 注意すべき点
上記の「システム全体像」「処理の流れ」No4に関する注意点について。
1. 本番リリース前日に非同期バッチにエントリされたが、処理されず次の日にまわされたとする。
2. 本番リリースで「処理の流れ」No4が実装される。
3. リリース後に、非同期バッチが再開する。
4. 必ずワークテーブルの連携データを参照するように実装していると、過渡期のデータは連携データがないので落ちる。

このように、過渡期のデータに関する実装や取り扱いを考慮する必要がある。
